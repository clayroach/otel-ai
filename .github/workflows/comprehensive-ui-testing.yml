name: Comprehensive UI Testing (All Browsers)

on:
  pull_request:
    branches: [main]
    paths:
      - 'ui/**'
      - 'playwright.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/comprehensive-ui-testing.yml'
  push:
    branches: [main]
    paths:
      - 'ui/**'
      - 'playwright.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/comprehensive-ui-testing.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

jobs:
  comprehensive-ui-testing:
    name: Multi-Browser UI Testing
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_API_KEY }}
        continue-on-error: true
          
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies (skipping optional native compilation)..."
          # For Dependabot PRs, allow lockfile updates
          if [ "${{ github.actor }}" == "dependabot[bot]" ]; then
            echo "ğŸ¤– Dependabot PR detected - allowing lockfile updates"
            pnpm install --no-frozen-lockfile --ignore-scripts
          else
            pnpm install --frozen-lockfile --ignore-scripts
          fi
          
      - name: Build required Docker images
        run: |
          echo "ğŸ—ï¸ Building required Docker images..."
          pnpm dev:build
          
      - name: Start infrastructure services
        run: |
          echo "ğŸš€ Starting infrastructure services..."
          pnpm dev:up
          echo "â³ Waiting for services to be ready..."
          sleep 30
          
      - name: Validate infrastructure health
        run: |
          echo "ğŸ¥ Validating infrastructure..."
          pnpm dev:validate
          
      - name: Run database migrations
        run: |
          echo "ğŸ—„ï¸ Running database migrations..."
          pnpm db:migrate
          
      - name: Start demo and install all Playwright browsers in parallel
        run: |
          echo "ğŸš€ Starting comprehensive UI testing setup..."
          
          # Start demo in background
          echo "ğŸ¬ Starting OpenTelemetry demo for realistic telemetry data..."
          pnpm demo:up &
          DEMO_PID=$!
          
          # Install ALL Playwright browsers for comprehensive testing
          echo "ğŸ“¥ Installing all Playwright browsers (Chromium, Firefox, WebKit)..."
          pnpm exec playwright install --with-deps &
          PLAYWRIGHT_PID=$!
          
          # Wait for both to complete
          echo "â³ Waiting for demo startup to complete..."
          wait $DEMO_PID
          echo "âœ… Demo startup completed"
          
          echo "â³ Waiting for Playwright installation to complete..."
          wait $PLAYWRIGHT_PID
          echo "âœ… All Playwright browsers installed"
          
          # Extended wait for telemetry data generation
          echo "â³ Waiting for demo services to generate telemetry data..."
          sleep 30
          pnpm demo:status || echo "Demo status check completed"
          sleep 90  # Extended wait for CI environments
          
      - name: Comprehensive E2E tests (All Browsers)
        run: |
          echo "ğŸ­ Running comprehensive E2E tests across all browsers..."
          echo "Testing on: Chromium, Firefox, WebKit"
          CI=true pnpm test:e2e:all
          
      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-ui-test-results
          path: |
            target/test-results/
            target/screenshots/
          retention-days: 7
          
      - name: Cleanup services
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up services..."
          pnpm demo:down || echo "Demo cleanup completed"
          pnpm dev:down
          docker system prune -f

  ui-testing-summary:
    name: UI Testing Summary
    runs-on: ubuntu-latest
    needs: [comprehensive-ui-testing]
    if: always()
    
    steps:
      - name: Report comprehensive UI testing results
        run: |
          echo "ğŸ“‹ Comprehensive UI Testing Results:"
          
          if [[ "${{ needs.comprehensive-ui-testing.result }}" == "success" ]]; then
            echo "âœ… All browsers (Chromium, Firefox, WebKit) passed UI testing"
            echo "ğŸ¯ UI changes validated across all supported browsers"
          else
            echo "âŒ Multi-browser UI testing failed"
            echo "ğŸ” Check individual browser test results for specific failures"
            exit 1
          fi