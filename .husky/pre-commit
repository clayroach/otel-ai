echo "üîç Running pre-commit checks..."

# Get list of staged files before formatting
STAGED_FILES=$(git diff --cached --name-only)

# Format all code
echo "üìù Formatting code..."
pnpm format

# Auto-stage any STAGED files that were formatted
echo "üì¶ Auto-staging formatted files..."
RESTAGED_COUNT=0
for file in $STAGED_FILES; do
    # Check if the file was modified by the formatter
    if git diff --name-only | grep -q "^$file$"; then
        git add "$file"
        RESTAGED_COUNT=$((RESTAGED_COUNT + 1))
    fi
done

if [ $RESTAGED_COUNT -gt 0 ]; then
    echo "   ‚úÖ Re-staged $RESTAGED_COUNT formatted file(s)"
else
    echo "   ‚úÖ No staged files needed formatting"
fi

# Run type checking for all packages with agent integration
pnpm typecheck:fix

echo "‚úÖ Pre-commit checks passed!"