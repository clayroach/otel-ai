# Demo Directory - Claude Context

## Overview
Integration with official OpenTelemetry Demo using "Bring Your Own Backend" approach. The demo runs microservices that send telemetry to our otel-ai platform instead of the demo's built-in collector.
This file is automatically read by Claude Code when working in the demo/ directory.

## Quick Commands

```bash
# Start demo (includes flagd feature flag service)
pnpm demo:up

# Stop demo
pnpm demo:down

# View logs
pnpm demo:logs

# Check status
pnpm demo:status

# Clean up (removes containers and volumes)
pnpm demo:clean

# Regenerate configuration after changes to demo-setup.ts
pnpm demo:setup
```

## Access Points

- **Demo Frontend**: http://localhost:8080
- **Load Generator UI**: http://localhost:8089
- **flagd UI**: http://localhost:8080/feature
- **Your Platform**: http://localhost:5173

## Service Ports

**Feature Flag Services:**
- `8013` - flagd gRPC API (OpenFeature SDK)
- `8016` - flagd HTTP/REST API

**Demo Services:**
- `8080` - Frontend proxy (main entry point)
- `8089` - Load generator (Locust UI)

## Directory Structure

```
demo/
├── CLAUDE.md                    # This file
└── otel-demo-app/              # Cloned OpenTelemetry demo (gitignored)
    ├── .env.override           # Environment variable overrides
    ├── docker-compose.override.yml  # Docker compose overrides
    └── setup-otel-ai.sh        # Setup verification script
```

## How It Works

1. **Network Integration**: Demo services join `otel-ai-network` to connect with platform
2. **Telemetry Redirection**: All services send OTLP data to `otel-ai-collector:4317/4318`
3. **Service Replacements**: Heavy components (Jaeger, Grafana, Prometheus) replaced with dummy containers
4. **Port Mappings**: Consistent ports exposed for flagd (8013, 8016) and demo services

## Feature Flags Available

The demo includes these feature flags (manageable via http://localhost:8080/feature):

- `productCatalogFailure` - Simulate product catalog failures
- `recommendationCacheFailure` - Cache failure simulation
- `adManualGc`, `adHighCpu`, `adFailure` - Ad service scenarios
- `kafkaQueueProblems` - Kafka issues
- `cartFailure` - Cart service failures
- `paymentFailure`, `paymentUnreachable` - Payment scenarios
- `loadGeneratorFloodHomepage` - Load testing
- `imageSlowLoad` - Slow image loading
- `emailMemoryLeak` - Memory leak simulation

## Configuration Files

### docker-compose.override.yml
Generated by `pnpm demo:setup`, contains:
- Network configuration to join otel-ai-network
- Dummy service replacements
- Port mappings for flagd (8013, 8016)
- Health check fixes

### .env.override
Environment variables pointing to our collector:
- `OTEL_COLLECTOR_HOST=otel-ai-collector`
- `OTEL_COLLECTOR_PORT_GRPC=4317`
- `OTEL_COLLECTOR_PORT_HTTP=4318`

## Modifying Demo Configuration

To change demo setup (ports, services, etc.):

1. Edit `scripts/demo-setup.ts` in main project
2. Run `pnpm demo:setup` to regenerate configs
3. Restart with `pnpm demo:down && pnpm demo:up`

## Integration Testing

The demo provides real services for integration testing:

```bash
# Run feature flag integration tests (requires demo running)
pnpm test:integration feature-flag

# Run all annotations package integration tests
pnpm test:integration src/annotations
```

## Troubleshooting

**Platform Not Running:**
```bash
# Start platform first
pnpm dev:up
# Then start demo
pnpm demo:up
```

**Port Conflicts:**
Check for services using required ports:
```bash
lsof -i :8013,8014,8016,8080,8089
```

**Reset Everything:**
```bash
pnpm demo:clean  # Remove demo containers
pnpm clean:all   # Remove all containers
pnpm dev:up      # Start platform
pnpm demo:up     # Start demo
```

## Implementation Notes

- Uses latest OpenTelemetry demo from main branch
- Implements "Bring Your Own Backend" pattern
- Reduces resource usage (5 Locust users vs default)
- Disables Tracetest component
- All telemetry flows through otel-ai-collector
- Demo is cloned to demo/otel-demo-app/ (gitignored)