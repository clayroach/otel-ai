# AI-Native Observability Platform
# Production usage: docker compose up -d
# Development usage: docker compose --profile dev up -d
# With test data: docker compose --profile dev --profile test-data up -d

services:
  # ClickHouse for analytics storage
  clickhouse:
    image: clickhouse/clickhouse-server:25.7
    container_name: otel-ai-clickhouse
    ports:
      - '8124:8123' # HTTP interface (using 8124 to avoid conflicts)
    environment:
      CLICKHOUSE_DB: otel
      CLICKHOUSE_USER: otel
      CLICKHOUSE_PASSWORD: otel123
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      # Memory optimization settings
      CLICKHOUSE_MAX_MEMORY_USAGE: 2000000000  # 2GB max memory per query
      CLICKHOUSE_MAX_MEMORY_USAGE_FOR_USER: 3000000000  # 3GB max memory per user
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      # init-db.sql removed - now handled by schema-migrator service
      - ./docker/clickhouse/config.xml:/etc/clickhouse-server/config.d/cors.xml
    healthcheck:
      test: ['CMD', 'clickhouse-client', '--user', 'otel', '--password', 'otel123', '--query', 'SELECT 1']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    # Resource limits to prevent OOM
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # MinIO for S3-compatible object storage (DISABLED for now)
  minio:
    image: minio/minio:latest
    container_name: otel-ai-minio
    ports:
      - '9001:9001' # Console
      - '9010:9000' # API
    environment:
      MINIO_ROOT_USER: otel-ai
      MINIO_ROOT_PASSWORD: otel-ai-secret
      MINIO_CONSOLE_ADDRESS: ':9001'
    volumes:
      - minio_data:/data
    command: server /data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 10s
      timeout: 5s
      retries: 5

  # Create MinIO bucket on startup (DISABLED for now)
  minio-bucket:
    image: minio/mc:latest
    container_name: otel-ai-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 otel-ai otel-ai-secret;
      /usr/bin/mc mb --ignore-existing myminio/otel-data;
      /usr/bin/mc anonymous set public myminio/otel-data;
      exit 0;
      "

  # Schema Migration Service - Manages all database schemas
  schema-migrator:
    build:
      context: ./migrations
      dockerfile: Dockerfile
    image: otel-ai-migrator:latest
    container_name: otel-ai-migrator
    profiles: ["migrate", "dev", "production", "test"]
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 9000
      CLICKHOUSE_DATABASE: otel
      CLICKHOUSE_USER: otel
      CLICKHOUSE_PASSWORD: otel123
      MIGRATION_MODE: migrate  # Options: migrate | init | validate | wait
    volumes:
      - ./migrations:/migrations:ro
    restart: "no"  # Run once and exit

  # OpenTelemetry Collector - Default (protobuf encoding)
  # S3 exporters always defined, enable by editing config/otel-collector/config.yaml
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-ai-collector
    ports:
      - '4317:4317' # OTLP gRPC receiver
      - '4318:4318' # OTLP HTTP receiver
      - '8888:8888' # Prometheus metrics
      - '13133:13133' # Health check
    volumes:
      - ./config/otel-collector/config.yaml:/etc/otelcol-contrib/config.yaml
    environment:
      # S3/MinIO configuration (for when S3 exporters are enabled in config)
      - AWS_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-otel-ai}
      - AWS_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-otel-ai-secret}
    depends_on:
      clickhouse:
        condition: service_healthy
    command: ['--config=/etc/otelcol-contrib/config.yaml']
    profiles:
      - dev
      - production
    # Health check disabled as it's not working reliably
    # The collector is healthy when port 13133 responds


  # UI Service - Production build by default
  ui-prod:
    build:
      context: ./ui
      dockerfile: Dockerfile
      target: production
    container_name: otel-ai-ui
    ports:
      - '80:80'
    depends_on:
      clickhouse:
        condition: service_healthy
      otel-collector:
        condition: service_started
    profiles:
      - production

  # UI Service - Development build with hot reload
  ui-dev:
    build:
      context: .
      dockerfile: ./ui/Dockerfile
      target: development
    container_name: otel-ai-ui-dev
    ports:
      - '5173:5173'
    environment:
      - NODE_ENV=development
      - VITE_CLICKHOUSE_URL=http://clickhouse:8123
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - VITE_BACKEND_HOST=backend
    volumes:
      - ./ui:/app
      - /app/node_modules
    depends_on:
      clickhouse:
        condition: service_healthy
      otel-collector:
        condition: service_started
    command: ['sh', '-c', 'pnpm install && pnpm dev:web --host 0.0.0.0']
    profiles:
      - dev

  # Portkey Gateway - LLM routing and management
  portkey-gateway:
    image: portkeyai/gateway:latest
    container_name: otel-ai-portkey
    ports:
      - '8787:8787'
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_LOW_TOKENS_API_KEY=${ANTHROPIC_LOW_TOKENS_API_KEY}
      - LM_STUDIO_ENDPOINT=${LM_STUDIO_ENDPOINT:-http://host.docker.internal:1234/v1}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT:-http://host.docker.internal:11434}
      - PORT=8787
      - LOG_LEVEL=debug  # Changed to debug for more visibility
      - CACHE_ENABLED=true
      - CACHE_TTL=3600
      - CONFIG_PATH=/config/config.json
    volumes:
      - ./config/portkey:/config:ro
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8787/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    profiles:
      - dev
      - production

  # Backend Service - OTLP ingestion and storage layer
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: otel-ai-backend
    ports:
      - '4319:4319' # OTLP ingestion endpoint for direct path
    environment:
      - NODE_ENV=production
      - PORT=4319
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DATABASE=otel
      - CLICKHOUSE_USERNAME=otel
      - CLICKHOUSE_PASSWORD=otel123
      # S3/MinIO Configuration
      - S3_ENDPOINT=http://minio:9000
      - S3_REGION=us-east-1
      - S3_BUCKET=otel-data
      - S3_ACCESS_KEY_ID=otel-ai
      - S3_SECRET_ACCESS_KEY=otel-ai-secret
      - S3_FORCE_PATH_STYLE=true
      # API Keys only
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Local Model Endpoints
      - LM_STUDIO_ENDPOINT=${LM_STUDIO_ENDPOINT:-http://host.docker.internal:1234/v1}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT:-http://host.docker.internal:11434}
      # Portkey Gateway configuration
      - PORTKEY_API_KEY=${PORTKEY_API_KEY:-portkey-virtual-key}
      - PORTKEY_GATEWAY_URL=http://portkey-gateway:8787
    volumes:
      - ./config/portkey:/app/config/portkey:ro
      - ./config/llm-manager.yaml:/app/config/llm-manager.yaml:ro
    depends_on:
      clickhouse:
        condition: service_healthy
      schema-migrator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4319/api/ai-analyzer/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    profiles:
      - dev
      - production
      - test

  # OTLP Replay Orchestrator - Replays captured sessions for test data
  replay-orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: otel-ai-replay-orchestrator
    environment:
      # MinIO/S3 Configuration
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_BUCKET=otel-data
      - MINIO_ACCESS_KEY=otel-ai
      - MINIO_SECRET_KEY=otel-ai-secret
      # Replay Configuration
      - REPLAY_SESSION_ID=${REPLAY_SESSION:-auto}
      - REPLAY_STRATEGY=${REPLAY_STRATEGY:-latest}
      - REPLAY_MAX_DURATION=${REPLAY_DURATION:-3600}
      - REPLAY_LOOP=${REPLAY_LOOP:-false}
      - REPLAY_SPEED=${REPLAY_SPEED:-1.0}
      - REPLAY_ENDPOINT=http://otel-collector:4318
      - REPLAY_TRACES=true
      - REPLAY_METRICS=true
      - REPLAY_LOGS=true
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_ENV=production
    volumes:
      - ./config/record-replay:/app/config/record-replay:ro
    depends_on:
      minio:
        condition: service_healthy
      otel-collector:
        condition: service_started
    command: ['node', 'dist/src/record-replay/cli/replay.js']
    restart: unless-stopped
    profiles:
      - test-data

  # Integration Test Runner - Runs AI Analyzer topology tests
  integration-tests:
    build:
      context: .
      dockerfile: docker/integration-tests/Dockerfile
    container_name: otel-ai-integration-tests
    environment:
      - API_URL=http://backend:4319
      - NODE_ENV=test
    depends_on:
      backend:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    profiles:
      - test
      - ci
    restart: "no"
    command: ["pnpm", "test:integration:ai-analyzer"]

volumes:
  clickhouse_data:
    name: otel-ai-clickhouse-data
  minio_data:
    name: otel-ai-minio-data

networks:
  default:
    name: otel-ai-network